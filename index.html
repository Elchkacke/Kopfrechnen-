<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kopfrechnen Trainer</title>
<meta name="robots" content="noindex">
<style>
  :root { --accent:#0a84ff; --ok:#34c759; --bad:#ff3b30; }
  html,body{margin:0;background:#fff;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  h1{margin:8px 0 12px}
  .card{border:1px solid #e5e5ea;border-radius:12px;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px;min-width:260px}
  label{display:block;margin:6px 0 4px;font-size:14px}
  input[type="text"],input[type="number"]{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #ccc;border-radius:8px;font-size:16px}
  button{appearance:none;border:none;background:var(--accent);color:#fff;border-radius:10px;padding:12px 16px;font-size:16px;cursor:pointer}
  button.secondary{background:#d1d1d6;color:#111}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .task-index{text-align:center;font-size:18px;color:#444}
  .task-big{font-weight:700;font-size:46px;text-align:center;margin:10px 0 8px}
  .input-inline{display:flex;gap:10px;justify-content:center;margin:10px 0}
  .input-inline input{max-width:220px;text-align:center;font-size:20px}
  .muted{color:#777;font-size:14px}
  .ok{color:var(--ok);font-weight:600}
  .bad{color:var(--bad);font-weight:600}
  pre{white-space:pre-wrap}
  dialog{border:none;border-radius:12px;padding:0;max-width:520px;width:calc(100% - 32px)}
  dialog .head{padding:14px 16px;font-weight:600;border-bottom:1px solid #eee}
  dialog .body{padding:14px 16px}
  dialog .foot{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">ðŸ§® Kopfrechnen Trainer</h1>

  <!-- Start (nur Name & Klasse) -->
  <section id="screen-start" class="card">
    <div class="row">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Vorname Nachname">
      </div>
      <div class="col">
        <label for="group">Klasse / Gruppe</label>
        <input id="group" type="text" placeholder="z. B. 5a">
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <button id="start" disabled>Start</button>
      <button id="ping" class="secondary" type="button">Server-Ping</button>
      <span id="cfgHint" class="muted">Konfiguration wird geladen â€¦</span>
    </div>
  </section>

  <!-- Quiz -->
  <section id="screen-quiz" class="card" style="display:none">
    <div id="taskIndex" class="task-index">Aufgabe â€” / â€”</div>
    <div id="taskText" class="task-big">â€”</div>
    <div class="input-inline">
      <input id="answer" type="text" inputmode="decimal" placeholder="Antwort">
      <button id="ok">OK</button>
    </div>
    <p id="progress" class="muted"></p>
  </section>

  <!-- Ergebnisse + Analyse -->
  <section id="screen-results" class="card" style="display:none">
    <h2>Auswertung</h2>
    <div id="summary" style="font-weight:600;margin-bottom:6px"></div>
    <div id="timing" class="muted"></div>
    <h3 style="margin-top:16px">Fehlerschwerpunkte</h3>
    <div id="hotspots" class="muted"></div>
    <h3>Details</h3>
    <pre id="details"></pre>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <button id="again" class="secondary">Neu starten</button>
      <button id="send">An Zentrale senden</button>
      <span id="sendStatus" class="muted"></span>
    </div>
  </section>
</div>

<!-- Lehrer-Dialog (Langdruck auf Titel) -->
<dialog id="adminDlg">
  <div class="head">Lehrer-Einstellungen</div>
  <div class="body">
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div><label>Anzahl Aufgaben</label><input id="cfg_count" type="number" min="1" max="200"></div>
      <div><label>Min (Â±)</label><input id="cfg_min" type="number"></div>
      <div><label>Max (Â±)</label><input id="cfg_max" type="number"></div>
      <div><label>Ã— bis</label><input id="cfg_multmax" type="number" min="1" max="20"></div>
      <div><label>Ã· bis</label><input id="cfg_divmax" type="number" min="1" max="20"></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
      <label><input type="checkbox" id="cfg_plus"> Plus</label>
      <label><input type="checkbox" id="cfg_minus"> Minus</label>
      <label><input type="checkbox" id="cfg_mult"> Mal</label>
      <label><input type="checkbox" id="cfg_div"> Geteilt</label>
      <label><input type="checkbox" id="cfg_allowneg"> Negative bei âˆ’ erlauben</label>
      <label><input type="checkbox" id="cfg_divint" checked> Ã· nur ganzzahlig</label>
    </div>
    <div class="muted" id="adminInfo" style="margin-top:6px"></div>
    <div style="margin-top:10px">
      <label>Admin-PIN</label>
      <input id="adminPin" type="password" placeholder="PIN eingeben">
    </div>
  </div>
  <div class="foot">
    <button class="secondary" id="adminCancel" type="button">SchlieÃŸen</button>
    <button id="adminSave" type="button">Speichern</button>
  </div>
</dialog>

<!-- Unsichtbare Bridge fÃ¼r CORS-freien Admin-Save -->
<form id="cfgForm" action="" method="POST" target="cfgBridge" style="display:none">
  <input type="hidden" name="type" value="config_form">
  <input type="hidden" name="admin_key" id="f_admin">
  <input type="hidden" name="cfg" id="f_cfg">
</form>
<iframe name="cfgBridge" id="cfgBridge" style="display:none"></iframe>

<script>
/* === Trage hier deine Google-Web-App-URL ein (endet auf /exec) === */
const SERVER_URL = "https://script.google.com/macros/s/AKfycbzNh5LLyC3e2DfHdgaFFZ_hIz7FlU0MjVSH0Oko3mAewDUs48aK2gHgUn2e6HY4oAz4jw/exec"
/* ================================================================ */

const S=id=>document.getElementById(id);
const show=id=>S(id).style.display='';
const hide=id=>S(id).style.display='none';

/* ===== Konfig-Status & Anzeige ===== */
let CFG = { count:12, ops:['+','-','*','/'], min:1, max:150, multMax:12, divMax:12, allowNeg:false, divInt:true };
let CFG_READY = false;

function cfgSummary(cfg) {
  const map = { '+':'Plus','-':'Minus','*':'Mal','/':'Geteilt' };
  const ops = (cfg.ops||[]).map(o=>map[o]||o).join(' Â· ') || 'â€“';
  return `Konfig: ${cfg.count} Aufgaben Â· ${ops} Â· Â± ${cfg.min}â€¦${cfg.max} Â· Ã—/Ã· bis ${cfg.multMax}/${cfg.divMax}` +
         (cfg.allowNeg?' Â· Minus erlaubt':'') + (cfg.divInt?' Â· Ã· ganzzahlig':'');
}
function renderCfgBadge(){
  S('cfgHint').textContent = CFG_READY ? cfgSummary(CFG) : 'Konfiguration wird geladen â€¦';
}

async function loadConfig(){
  CFG_READY = false; renderCfgBadge();
  try{
    const r  = await fetch(SERVER_URL + '?action=config&t=' + Date.now());
    const js = await r.json();
    if (js && js.ok && js.config) {
      CFG = js.config;
      CFG_READY = true;
      S('start').disabled = false;
      renderCfgBadge();
      return;
    }
    CFG_READY = true; S('start').disabled = false;
    S('cfgHint').textContent = 'Standard-Konfig aktiv (Server-Antwort unklar).';
  }catch(e){
    CFG_READY = true; S('start').disabled = false;
    S('cfgHint').textContent = 'Konfig nicht erreichbar â€“ Standard.';
  }
}

/* ===== Aufgaben-Generator (nutzt CFG) ===== */
function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function makeTask(){
  const ops = (CFG.ops && CFG.ops.length)? CFG.ops : ['+','-','*','/'];
  const op = ops[Math.floor(Math.random()*ops.length)];
  if (op === '+'){ const a=rnd(CFG.min,CFG.max), b=rnd(CFG.min,CFG.max); return {q:`${a} + ${b}`, v:a+b, op:'+'}; }
  if (op === '-'){ let a=rnd(CFG.min,CFG.max), b=rnd(CFG.min,CFG.max); if (!CFG.allowNeg && a<b) [a,b]=[b,a]; return {q:`${a} âˆ’ ${b}`, v:a-b, op:'-'}; }
  if (op === '*'){ const a=rnd(1,CFG.multMax), b=rnd(1,CFG.multMax); return {q:`${a} Ã— ${b}`, v:a*b, op:'*'}; }
  if (CFG.divInt){ const res=rnd(1,CFG.divMax), b=rnd(1,CFG.divMax), a=res*b; return {q:`${a} Ã· ${b}`, v:res, op:'/'}; }
  const a=rnd(1,CFG.max), b=rnd(1,CFG.divMax); return {q:`${a} Ã· ${b}`, v:(a/b), op:'/'}; // nicht-ganzzahlig
}

/* ===== Laufvariablen ===== */
let tasks=[],results=[],opsUsed=[],times=[],answers=[],corrects=[];
let idx=0, tStart=0, runId=null, sent=false, sending=false, user={name:'', group:''};

/* ===== Start / Render / Submit ===== */
function start(){
  if (!CFG_READY){ alert('Bitte einen Moment â€“ Konfiguration lÃ¤dt noch.'); return; }
  const name = S('name').value.trim();
  const group= S('group').value.trim();
  if (!name || !group){ alert('Bitte Name und Klasse eingeben.'); return; }
  user={name, group};

  tasks=[]; results=[]; opsUsed=[]; times=[]; answers=[]; corrects=[];
  const N = Math.max(1, Math.min(200, CFG.count||12));
  for (let i=0;i<N;i++){ const t=makeTask(); tasks.push(t.q); results.push(t.v); opsUsed.push(t.op); }

  idx=0; runId=`run_${Date.now()}_${Math.random().toString(16).slice(2)}`; sent=false; sending=false;
  hide('screen-start'); show('screen-quiz'); render();
}

function render(){
  if (idx>=tasks.length){ showResults(); return; }
  S('taskIndex').textContent = `Aufgabe ${idx+1} / ${tasks.length}`;
  S('taskText').textContent  = tasks[idx];
  S('progress').textContent  = '';
  S('answer').value=''; S('answer').disabled=false; S('ok').disabled=false; S('answer').focus();
  tStart = performance.now();
}

function submit(){
  if (idx>=tasks.length) return;
  S('answer').disabled=true; S('ok').disabled=true;

  const dt = (performance.now()-tStart)/1000; times.push(dt);
  let val = (S('answer').value||'').trim().replace(',','.');
  if (val===''){ alert('Bitte Zahl eingeben.'); times.pop(); S('answer').disabled=false; S('ok').disabled=false; S('answer').focus(); return; }
  const a = Number(val);
  if (!isFinite(a)){ alert('Bitte gÃ¼ltige Zahl eingeben.'); times.pop(); S('answer').disabled=false; S('ok').disabled=false; S('answer').focus(); return; }

  answers.push(a);
  const ok = (Math.abs(a - results[idx]) < 1e-9); corrects.push(ok);
  idx++;
  setTimeout(render, 120); // Entprellung
}

/* ===== Analyse & Senden ===== */
function showResults(){
  hide('screen-quiz'); show('screen-results');

  const total = tasks.length;
  const right = corrects.filter(Boolean).length;
  const pct   = total? (100*right/total):0;

  const avg = times.reduce((x,y)=>x+y,0)/(times.length||1);
  const sorted=[...times].sort((a,b)=>a-b);
  const med = sorted.length?(sorted.length%2?sorted[(sorted.length-1)/2]:(sorted[sorted.length/2-1]+sorted[sorted.length/2])/2):0;

  S('summary').textContent = `${user.name} (${user.group}) â€“ Richtig: ${right}/${total} (${pct.toFixed(1)}%)`;
  S('timing').textContent  = `Ã˜ Zeit/Aufgabe: ${avg.toFixed(2)}s â€¢ Median: ${med.toFixed(2)}s â€¢ Schnellste: ${Math.min(...times).toFixed(2)}s â€¢ Langsamste: ${Math.max(...times).toFixed(2)}s`;

  const per={'+':[0,0],'-':[0,0],'*':[0,0],'/':[0,0]};
  corrects.forEach((ok,i)=>{ per[opsUsed[i]][1]++; if (ok) per[opsUsed[i]][0]++; });
  let hot='<ul>';
  Object.entries(per).forEach(([op,[ok,tot]])=>{
    if (!tot) return;
    const acc = Math.round(100*ok/tot);
    const cls = acc<70?'bad':(acc>=90?'ok':'');
    hot += `<li>${op}: <span class="${cls}">${ok}/${tot} (${acc}%)</span></li>`;
  });
  hot+='</ul>';
  S('hotspots').innerHTML = hot;

  const lines=[];
  tasks.forEach((q,i)=>{
    lines.push(`${i+1}. ${q} = ${results[i]} | deine Antwort: ${answers[i]}   ${corrects[i]?'âœ“':'âœ—'}   (${opsUsed[i]}, ${times[i].toFixed(2)}s)`);
  });
  S('details').textContent = lines.join('\n');

  setSendBtn(true);
}

function dataset(){
  const right = corrects.filter(Boolean).length;
  const time  = times.reduce((x,y)=>x+y,0);
  const score = right*100 - time;
  return {
    run_id: runId,
    name: user.name,
    group: user.group,
    total: tasks.length,
    correct: right,
    time: Number(time.toFixed(2)),
    score: Number(score.toFixed(0))
  };
}

function setSendBtn(enabled){
  S('send').disabled = !enabled;
  S('send').textContent = enabled? 'An Zentrale senden' : 'Bereits gesendet';
}

async function sendOnce(){
  if (sent || sending) return;
  sent=true; sending=true; setSendBtn(false);
  S('sendStatus').textContent = 'Sende â€¦';
  try{
    const r = await fetch(SERVER_URL + '?t=' + Date.now(), {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(dataset())
    });
    let js=null; try{ js=await r.json(); }catch(_){}
    if (r.ok && js){
      S('sendStatus').textContent = js.dedup ? 'Bereits Ã¼bertragen.' : 'Daten gesendet.';
    } else {
      S('sendStatus').textContent = 'Fehler: HTTP ' + r.status;
    }
  }catch(e){
    S('sendStatus').textContent = 'Fehler: ' + e.message;
  }finally{
    sending=false;
  }
}

/* ===== Verstecktes Lehrer-MenÃ¼ (Langdruck auf Titel) ===== */
let _pressTimer=null;
S('title').addEventListener('touchstart', ()=> _pressTimer=setTimeout(openAdmin, 2000));
S('title').addEventListener('mousedown',  ()=> _pressTimer=setTimeout(openAdmin, 2000));
['touchend','mouseup','mouseleave'].forEach(ev=> S('title').addEventListener(ev, ()=> clearTimeout(_pressTimer)));

async function openAdmin(){
  S('cfg_count').value   = CFG.count;
  S('cfg_min').value     = CFG.min;
  S('cfg_max').value     = CFG.max;
  S('cfg_multmax').value = CFG.multMax;
  S('cfg_divmax').value  = CFG.divMax;
  S('cfg_plus').checked  = (CFG.ops||[]).includes('+');
  S('cfg_minus').checked = (CFG.ops||[]).includes('-');
  S('cfg_mult').checked  = (CFG.ops||[]).includes('*');
  S('cfg_div').checked   = (CFG.ops||[]).includes('/');
  S('cfg_allowneg').checked = !!CFG.allowNeg;
  S('cfg_divint').checked   = !!CFG.divInt;
  S('adminPin').value='';
  S('adminInfo').textContent='Langdruck erkannt â€“ zentrale Ã„nderung.';
  S('adminDlg').showModal();
}

S('adminCancel').addEventListener('click', ()=> S('adminDlg').close());

/* ===== Admin speichern via unsichtbarem Formular â†’ Iframe (kein CORS) ===== */
S('adminSave').addEventListener('click', async ()=>{
  const newCfg = {
    count:  Math.max(1, Math.min(200, parseInt(S('cfg_count').value,10)||12)),
    min:    parseInt(S('cfg_min').value,10)||1,
    max:    parseInt(S('cfg_max').value,10)||150,
    multMax:parseInt(S('cfg_multmax').value,10)||12,
    divMax: parseInt(S('cfg_divmax').value,10)||12,
    ops: ['+','-','*','/'].filter((op,i)=> [S('cfg_plus'),S('cfg_minus'),S('cfg_mult'),S('cfg_div')][i].checked),
    allowNeg: !!S('cfg_allowneg').checked,
    divInt:   !!S('cfg_divint').checked
  };
  if (!newCfg.ops.length){ alert('Mindestens einen Operator wÃ¤hlen.'); return; }
  const pin = S('adminPin').value.trim(); if (!pin){ alert('Admin-PIN erforderlich.'); return; }

  S('adminInfo').textContent='Speichere â€¦';
  const form = S('cfgForm'); form.action = SERVER_URL;
  S('f_admin').value = pin; S('f_cfg').value = JSON.stringify(newCfg);

  const iframe = S('cfgBridge');
  const onLoaded = async () => {
    try { await loadConfig(); renderCfgBadge(); S('adminInfo').textContent = 'Gespeichert. (Ã¼bernommen)'; }
    catch(e){ S('adminInfo').textContent = 'Gespeichert (prÃ¼fe mit Reload).'; }
    iframe.removeEventListener('load', onLoaded);
  };
  iframe.addEventListener('load', onLoaded);
  form.submit();
});

/* ===== Events ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  S('start').disabled = true;        // bis Konfig geladen ist
  renderCfgBadge();
  loadConfig();                      // Konfig sofort holen

  S('start').addEventListener('click', start);
  S('ok').addEventListener('click', submit);
  S('answer').addEventListener('keydown', e=>{ if (e.key==='Enter') submit(); });
  S('again').addEventListener('click', ()=>{ hide('screen-results'); show('screen-start'); });
  S('send').addEventListener('click', sendOnce);

  S('ping').addEventListener('click', async ()=>{
    try{ const r=await fetch(SERVER_URL+'?ping=1'); S('cfgHint').textContent = r.ok ? cfgSummary(CFG) : ('Ping HTTP '+r.status); }
    catch(e){ S('cfgHint').textContent = 'Ping fehlgeschlagen: '+e.message; }
  });

  // Solange der Startscreen sichtbar ist, alle 30s Konfig neu ziehen
  setInterval(()=>{
    const startVisible = S('screen-start').style.display !== 'none';
    if (startVisible) loadConfig();
  }, 30000);
});
</script>
</body>
</html>
