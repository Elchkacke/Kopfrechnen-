<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kopfrechnen Trainer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f4f4f5;
      margin:0;
      padding:16px;
      text-align:center;
    }
    .card {
      max-width:600px;
      margin:0 auto;
      background:white;
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    h1 { margin-top:0; }
    input {
      font-size:16px;
      padding:8px;
      width:100%;
      max-width:260px;
      border-radius:8px;
      border:1px solid #d4d4d8;
      margin:4px 0 10px;
    }
    button {
      font-size:16px;
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      margin:4px;
    }
    button.primary { background:#2563eb; color:white; }
    button.secondary { background:#e4e4e7; color:#111827; }

    #taskBox {
      margin-top:16px;
      padding:12px;
      border-radius:12px;
      background:#f9fafb;
      display:none;
    }
    #resultBox {
      margin-top:16px;
      padding:12px;
      border-radius:12px;
      background:#ecfdf3;
      display:none;
    }
    .label { font-weight:600; }
    #status { margin-top:8px; font-size:14px; color:#4b5563; }

    /* Lehrer-Leiste */
    #topBar {
      max-width:600px;
      margin:0 auto 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    #cfgInfo {
      font-size:13px;
      color:#4b5563;
      text-align:left;
      flex:1;
    }
    #topButtons {
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }

    /* Lehrer-Men√º (Overlay) */
    #teacherOverlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    #teacherPanel {
      background:white;
      border-radius:12px;
      max-width:420px;
      width:90%;
      padding:16px;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      text-align:left;
    }
    #teacherPanel h2 { margin-top:0; text-align:center; }
    #teacherPanel label { display:block; margin:6px 0 2px; font-size:14px; font-weight:600; }
    #teacherPanel input[type="number"],
    #teacherPanel input[type="password"] {
      width:100%;
      max-width:none;
      margin-bottom:6px;
    }
    #teacherPanel .row { display:flex; justify-content:space-between; gap:8px; margin-top:10px; }
    #teacherMsg { font-size:13px; color:#4b5563; margin-top:4px; min-height:18px; }
    .ops-row { display:flex; gap:8px; margin-top:4px; flex-wrap:wrap; }
    .chip {
      display:inline-block;
      border-radius:999px;
      border:1px solid #d4d4d8;
      padding:4px 10px;
      cursor:pointer;
      font-weight:600;
      user-select:none;
    }
    .chip.active {
      background:#2563eb;
      color:white;
      border-color:#2563eb;
    }
  </style>
</head>
<body>
  <!-- Lehrer-Leiste -->
  <div id="topBar">
    <div id="cfgInfo">Konfiguration: wird geladen ‚Ä¶</div>
    <div id="topButtons">
      <button id="btnDashboard" class="secondary">üìä Dashboard</button>
      <button id="btnTeacher" class="secondary">‚öôÔ∏è Lehrer-Men√º</button>
    </div>
  </div>

  <div class="card">
    <h1>üßÆ Kopfrechnen Trainer</h1>

    <!-- Startbereich: Name & Klasse -->
    <div id="startBox">
      <p>Bitte Name und Klasse eingeben:</p>
      <div>
        <div class="label">Name</div>
        <input id="inpName" placeholder="Vorname Nachname">
      </div>
      <div>
        <div class="label">Klasse</div>
        <input id="inpClass" placeholder="z. B. 5a">
      </div>
      <button id="btnStart" class="primary">Los geht‚Äôs</button>
    </div>

    <!-- Aufgabenbereich -->
    <div id="taskBox">
      <div id="taskHeader" class="label"></div>
      <div id="taskText" style="font-size:26px; margin:12px 0;"></div>
      <div>
        <div>Deine Antwort:</div>
        <input id="inpAnswer" type="number" inputmode="decimal">
      </div>
      <button id="btnNext" class="primary">Weiter</button>
      <button id="btnAbort" class="secondary">Abbrechen</button>
    </div>

    <!-- Ergebnisbereich -->
    <div id="resultBox">
      <h3>Auswertung</h3>
      <div id="resultText"></div>
      <div id="status"></div>
      <button id="btnRestart" class="secondary">Neue Runde</button>
    </div>
  </div>

  <!-- Lehrer-Men√º Overlay -->
  <div id="teacherOverlay">
    <div id="teacherPanel">
      <h2>Lehrer-Konfiguration</h2>
      <label for="teacherPin">Lehrer-PIN</label>
      <input type="password" id="teacherPin" placeholder="PIN eingeben">

      <label>Anzahl Aufgaben</label>
      <input type="number" id="cfgCount" min="1" max="200">

      <label>Zahlenbereich (Min / Max)</label>
      <div class="row">
        <input type="number" id="cfgMin" placeholder="Min">
        <input type="number" id="cfgMax" placeholder="Max">
      </div>

      <label>Rechenarten</label>
      <div class="ops-row" id="opsRow">
        <div class="chip" data-op="+">+</div>
        <div class="chip" data-op="-">‚àí</div>
        <div class="chip" data-op="*">√ó</div>
        <div class="chip" data-op="/">√∑</div>
      </div>

      <label>Multiplikations-Max (√ó)</label>
      <input type="number" id="cfgMultMax">

      <label>Divisions-Max (√∑)</label>
      <input type="number" id="cfgDivMax">

      <label><input type="checkbox" id="cfgNeg"> Negative Ergebnisse erlauben</label><br>
      <label><input type="checkbox" id="cfgDivInt" checked> Division nur ganzzahlig</label>

      <div id="teacherMsg"></div>

      <div class="row" style="margin-top:12px;">
        <button id="teacherApply" class="primary">√úbernehmen</button>
        <button id="teacherClose" class="secondary">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script>
    /********** 1. SERVER-URL & LEHRER-PIN **********/
    // HIER deine NEUE Web-App-URL eintragen (mit /exec am Ende)
    const SERVER_URL = 'https://script.google.com/macros/s/AKfycbwYNz1gUUL0OdyPu4tsaobGO2m0x7BPJnVvD5meydPFUQp3j64f4eRtEVOl1Xdy9EtMnQ/exec';
    const DASHBOARD_BASE_URL = SERVER_URL + '?action=dashboard';
    const TEACHER_PIN = '1234';

    /********** 2. Konfiguration + localStorage **********/
    const CONFIG_KEY = 'kopf_config_v1';

    let CONFIG = {
      count: 10,
      min: 1,
      max: 150,
      ops: ['+','-','*','/'],
      allowNeg: false,
      divInt: true,
      multMax: 12,
      divMax: 12
    };

    const S = id => document.getElementById(id);

    function loadConfigFromStorage(){
      try {
        const raw = localStorage.getItem(CONFIG_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        if (saved && typeof saved === 'object') {
          CONFIG = Object.assign(CONFIG, saved);
        }
      } catch (e) {
        console.warn('Konfiguration konnte nicht aus localStorage geladen werden:', e);
      }
    }

    function saveConfigToStorage(){
      try {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(CONFIG));
      } catch (e) {
        console.warn('Konfiguration konnte nicht im localStorage gespeichert werden:', e);
      }
    }

    function updateCfgInfo(){
      const opsText = (CONFIG.ops && CONFIG.ops.length) ? CONFIG.ops.join(' ') : '‚Äî';
      S('cfgInfo').textContent = `Konfiguration: ${CONFIG.count} Aufgaben, Bereich ${CONFIG.min}‚Äì${CONFIG.max}, Ops: ${opsText}`;
    }

    /********** 3. Aufgaben-Generator **********/
    function randInt(a,b){
      return Math.floor(Math.random() * (b - a + 1)) + a;
    }

    function generateTask(){
      const ops = CONFIG.ops && CONFIG.ops.length ? CONFIG.ops : ['+'];
      const op = ops[Math.floor(Math.random() * ops.length)];
      let a, b, erg;

      if (op === '+') {
        a = randInt(CONFIG.min, CONFIG.max);
        b = randInt(CONFIG.min, CONFIG.max);
        erg = a + b;
      } else if (op === '-') {
        a = randInt(CONFIG.min, CONFIG.max);
        b = randInt(CONFIG.min, CONFIG.max);
        erg = a - b;
        if (!CONFIG.allowNeg && erg < 0) {
          const tmp = a; a = b; b = tmp;
          erg = a - b;
        }
      } else if (op === '*') {
        a = randInt(1, CONFIG.multMax || 12);
        b = randInt(1, CONFIG.multMax || 12);
        erg = a * b;
      } else if (op === '/') {
        if (CONFIG.divInt) {
          b = randInt(1, CONFIG.divMax || 12);
          erg = randInt(1, CONFIG.divMax || 12);
          a = b * erg;
        } else {
          b = randInt(1, CONFIG.divMax || 12);
          a = randInt(1, (CONFIG.divMax || 12) * (CONFIG.divMax || 12));
          erg = a / b;
        }
      } else {
        a = randInt(CONFIG.min, CONFIG.max);
        b = randInt(CONFIG.min, CONFIG.max);
        erg = a + b;
      }
      return { a, b, op, erg };
    }

    /********** 4. Zust√§nde **********/
    let currentIndex = 0;
    let tasks = [];
    let answers = [];
    let startTime = null;
    let studentName = '';
    let studentClass = '';

    /********** 5. UI-Funktionen **********/
    function showStart(){
      S('startBox').style.display = 'block';
      S('taskBox').style.display = 'none';
      S('resultBox').style.display = 'none';
      S('status').textContent = '';
    }

    function showTask(){
      S('startBox').style.display = 'none';
      S('taskBox').style.display = 'block';
      S('resultBox').style.display = 'none';

      const t = tasks[currentIndex];
      S('taskHeader').textContent = 'Aufgabe ' + (currentIndex + 1) + ' von ' + CONFIG.count;
      S('taskText').textContent = t.a + ' ' + t.op + ' ' + t.b + ' = ?';
      S('inpAnswer').value = '';
      S('inpAnswer').focus();
    }

    function showResult(){
      S('startBox').style.display = 'none';
      S('taskBox').style.display = 'none';
      S('resultBox').style.display = 'block';

      let correct = 0;
      let detail = '';
      for (let i = 0; i < tasks.length; i++) {
        const t = tasks[i];
        const userAns = answers[i];
        const ok = Math.abs(userAns - t.erg) < 0.0001;
        if (ok) correct++;
        detail +=
          (i+1) + '. ' +
          t.a + ' ' + t.op + ' ' + t.b +
          ' = ' + t.erg +
          ' (deine Antwort: ' + userAns + (ok ? ' ‚úì' : ' ‚úó') + ')<br>';
      }

      const total = tasks.length;
      const durationSec = (Date.now() - startTime) / 1000;
      const pct = total > 0 ? (correct / total * 100 * 1.0).toFixed(1) : '0.0';

      S('resultText').innerHTML =
        '<p>' + studentName + ' (' + studentClass + ')</p>' +
        '<p>Richtig: ' + correct + ' von ' + total + ' (' + pct + '%)</p>' +
        '<p>Gesamtzeit: ' + durationSec.toFixed(1) + ' s (√ò ' +
        (durationSec/total).toFixed(2) + ' s pro Aufgabe)</p>' +
        '<hr>' + detail;

      sendResults(total, correct, durationSec);
    }

    /********** 6. Ergebnisse + Aufgaben an Server senden **********/
    async function sendResults(total, correct, timeSec){
      S('status').textContent = 'Sende Ergebnisse ‚Ä¶';

      const taskPayload = tasks.map((t, idx) => {
        const ans = answers[idx];
        const ok = Math.abs(ans - t.erg) < 0.0001;
        return {
          index: idx + 1,
          a: t.a,
          b: t.b,
          op: t.op,
          answer: ans,
          solution: t.erg,
          correct: ok
        };
      });

      const payload = {
        run_id: 'run-' + Date.now(),
        name: studentName,
        group: studentClass,
        total: total,
        correct: correct,
        time: timeSec,
        score: correct * 10,
        tasks: taskPayload
      };

      try {
        await fetch(SERVER_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {'Content-Type': 'text/plain;charset=utf-8'},
          body: JSON.stringify(payload)
        });
        S('status').textContent = 'Ergebnisse wurden an den Server gesendet.';
      } catch (e) {
        S('status').textContent = 'Netzwerkfehler beim Senden: ' + e.message;
        console.error('SEND ERROR', e);
      }
    }

    /********** 7. Sch√ºler-Events **********/
    S('btnStart').addEventListener('click', () => {
      studentName = S('inpName').value.trim();
      studentClass = S('inpClass').value.trim();
      if (!studentName || !studentClass) {
        alert('Bitte Name und Klasse eingeben.');
        return;
      }
      tasks = [];
      answers = [];
      for (let i = 0; i < CONFIG.count; i++) {
        tasks.push(generateTask());
      }
      currentIndex = 0;
      startTime = Date.now();
      showTask();
    });

    S('btnNext').addEventListener('click', () => {
      const val = S('inpAnswer').value;
      if (val === '') {
        alert('Bitte eine Antwort eingeben.');
        return;
      }
      answers[currentIndex] = Number(val);
      if (currentIndex < CONFIG.count - 1) {
        currentIndex++;
        showTask();
      } else {
        showResult();
      }
    });

    S('btnAbort').addEventListener('click', () => {
      if (confirm('Willst du wirklich abbrechen?')) {
        showStart();
      }
    });

    S('btnRestart').addEventListener('click', () => {
      showStart();
    });

    S('inpAnswer').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        S('btnNext').click();
      }
    });

    /********** 8. Lehrer-Men√º **********/
    const overlay = S('teacherOverlay');
    const opsRow = S('opsRow');

    function openTeacher(){
      S('cfgCount').value   = CONFIG.count;
      S('cfgMin').value     = CONFIG.min;
      S('cfgMax').value     = CONFIG.max;
      S('cfgMultMax').value = CONFIG.multMax;
      S('cfgDivMax').value  = CONFIG.divMax;
      S('cfgNeg').checked   = CONFIG.allowNeg;
      S('cfgDivInt').checked= CONFIG.divInt;

      const set = new Set((CONFIG.ops || ['+']).map(String));
      Array.from(opsRow.querySelectorAll('.chip')).forEach(ch=>{
        ch.classList.toggle('active', set.has(ch.dataset.op));
      });

      S('teacherMsg').textContent = '';
      S('teacherPin').value = '';
      overlay.style.display = 'flex';
    }
    function closeTeacher(){ overlay.style.display = 'none'; }

    S('btnTeacher').addEventListener('click', openTeacher);
    S('teacherClose').addEventListener('click', closeTeacher);
    overlay.addEventListener('click', (e)=>{
      if (e.target === overlay) closeTeacher();
    });

    opsRow.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip');
      if (!chip) return;
      chip.classList.toggle('active');
    });

    S('teacherApply').addEventListener('click', ()=>{
      const pin = S('teacherPin').value.trim();
      if (pin !== TEACHER_PIN) {
        S('teacherMsg').textContent = 'Falsche PIN.';
        return;
      }
      const newCfg = {
        count: Number(S('cfgCount').value || CONFIG.count),
        min: Number(S('cfgMin').value || CONFIG.min),
        max: Number(S('cfgMax').value || CONFIG.max),
        multMax: Number(S('cfgMultMax').value || CONFIG.multMax),
        divMax: Number(S('cfgDivMax').value || CONFIG.divMax),
        allowNeg: !!S('cfgNeg').checked,
        divInt: !!S('cfgDivInt').checked,
        ops: []
      };
      const activeOps = Array.from(opsRow.querySelectorAll('.chip.active')).map(ch=>ch.dataset.op);
      newCfg.ops = activeOps.length ? activeOps : ['+'];

      CONFIG = newCfg;
      saveConfigToStorage();      // üëâ HIER: dauerhaft speichern
      updateCfgInfo();
      S('teacherMsg').textContent = 'Konfiguration √ºbernommen und gespeichert.';
      setTimeout(closeTeacher, 700);
    });

    /********** 9. Dashboard-Button **********/
    S('btnDashboard').addEventListener('click', () => {
      const pin = prompt('Lehrer-PIN f√ºr Dashboard:');
      if (pin === null) return;
      if (pin.trim() !== TEACHER_PIN) {
        alert('Falsche PIN.');
        return;
      }
      const url = DASHBOARD_BASE_URL + '&admin_key=' + encodeURIComponent(pin.trim());
      window.open(url, '_blank');
    });

    // Startzustand: Konfig aus localStorage holen, dann UI setzen
    loadConfigFromStorage();
    updateCfgInfo();
    showStart();
  </script>
</body>
</html>
