<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kopfrechnen Trainer</title>
<style>
  :root { --accent:#0a84ff; --muted:#f2f2f7; --danger:#ff3b30; --ok:#34c759; }
  html,body { margin:0; height:100%; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:#fff; color:#111; }
  .wrap { max-width:900px; margin:0 auto; padding:16px; }
  h1 { font-size:28px; margin:12px 0 4px; }
  h2 { font-size:22px; margin:20px 0 8px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  label { display:block; font-size:14px; color:#333; margin-bottom:6px; }
  input[type="text"], input[type="number"] { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #ccc; border-radius:8px; font-size:16px; background:#fff; }
  input[type="checkbox"] { transform:scale(1.2); }
  .col { flex:1 1 160px; min-width:160px; }
  .ops { display:flex; gap:10px; flex-wrap:wrap; }
  .toggle { min-width:56px; padding:10px 14px; text-align:center; border-radius:10px; border:1px solid #bbb; background:var(--muted); cursor:pointer; user-select:none; font-size:20px; }
  .toggle.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  .buttons { display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
  button { appearance:none; border:none; padding:12px 16px; border-radius:10px; font-size:16px; cursor:pointer; background:var(--accent); color:#fff; }
  button.secondary { background:#d1d1d6; color:#111; }
  .card { background:#fff; border:1px solid #e5e5ea; border-radius:14px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.05); }
  .big { font-weight:700; font-size:40px; text-align:center; line-height:1.25; }
  .input-inline { display:flex; gap:10px; justify-content:center; margin:14px 0 6px; }
  .input-inline input { max-width:220px; text-align:center; font-size:20px; }
  .muted { color:#777; font-size:14px; }
  .results pre { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:16px; }
  .ok { color:var(--ok); font-weight:600; }
  .bad { color:var(--danger); font-weight:600; }
  hr { border:none; border-top:1px solid #eee; margin:16px 0; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .advbox { background:#fafafa; border:1px dashed #d0d0d0; border-radius:12px; padding:12px; margin-top:10px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border-bottom:1px solid #eee; padding:8px; text-align:center; }
  th { font-weight:600; }
  @media (max-width:700px){ .grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸ§® Kopfrechnen Trainer</h1>

  <!-- SETTINGS -->
  <section id="screen-settings" class="card">
    <h2>Einstellungen</h2>
    <div class="row">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Vor- und Nachname">
      </div>
      <div class="col">
        <label for="group">Klasse/Gruppe</label>
        <input id="group" type="text" placeholder="z. B. 5b">
      </div>
    </div>

    <h3>Rechenarten (Mehrfachwahl)</h3>
    <div class="ops" id="ops">
      <div class="toggle active" data-op="+">+</div>
      <div class="toggle" data-op="-">âˆ’</div>
      <div class="toggle" data-op="*">Ã—</div>
      <div class="toggle" data-op="/">Ã·</div>
    </div>

    <!-- Gemeinsamer Bereich -->
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label for="min">Gemeinsames Minimum</label>
        <input id="min" type="number" value="1">
      </div>
      <div class="col">
        <label for="max">Gemeinsames Maximum</label>
        <input id="max" type="number" value="150">
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <div class="row">
          <label><input id="neg" type="checkbox"> Negative Ergebnisse erlauben</label>
        </div>
        <div class="row" style="margin-top:6px">
          <label><input id="divInt" type="checkbox" checked> Geteilt nur ganzzahlig</label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="col">
        <label for="count">Anzahl Aufgaben</label>
        <input id="count" type="number" value="7" min="1" max="500">
      </div>
      <div class="col">
        <label for="gap">Abstand zwischen Aufgaben (s)</label>
        <input id="gap" type="number" step="0.1" value="0.5">
      </div>
      <div class="col">
        <label for="think">Denkpause vor LÃ¶sungen (s)</label>
        <input id="think" type="number" step="1" value="0">
      </div>
    </div>

    <!-- Erweiterte Einstellungen je Rechenart -->
    <div class="advbox">
      <label><input id="advToggle" type="checkbox"> Erweiterte Einstellungen je Rechenart verwenden</label>
      <div id="advPanel" style="display:none; margin-top:8px">
        <table>
          <thead>
            <tr><th>Operator</th><th>Aktiv</th><th>Min</th><th>Max</th><th>Gewichtung</th></tr>
          </thead>
          <tbody>
            <tr data-op="+"><td>+</td>
              <td><input type="checkbox" class="op-active" checked></td>
              <td><input type="number" class="op-min" value="1"></td>
              <td><input type="number" class="op-max" value="150"></td>
              <td><input type="number" class="op-weight" value="1" min="0" step="1"></td>
            </tr>
            <tr data-op="-"><td>âˆ’</td>
              <td><input type="checkbox" class="op-active"></td>
              <td><input type="number" class="op-min" value="1"></td>
              <td><input type="number" class="op-max" value="150"></td>
              <td><input type="number" class="op-weight" value="1" min="0" step="1"></td>
            </tr>
            <tr data-op="*"><td>Ã—</td>
              <td><input type="checkbox" class="op-active"></td>
              <td><input type="number" class="op-min" value="1"></td>
              <td><input type="number" class="op-max" value="12"></td>
              <td><input type="number" class="op-weight" value="1" min="0" step="1"></td>
            </tr>
            <tr data-op="/"><td>Ã·</td>
              <td><input type="checkbox" class="op-active"></td>
              <td><input type="number" class="op-min" value="1"></td>
              <td><input type="number" class="op-max" value="12"></td>
              <td><input type="number" class="op-weight" value="1" min="0" step="1"></td>
            </tr>
          </tbody>
        </table>
        <p class="muted">Gewichtung: 0 = nie; 1,2,â€¦ = relative HÃ¤ufigkeit.</p>
      </div>
    </div>

    <div class="buttons">
      <button id="start">Start</button>
      <button id="quit" class="secondary">Beenden</button>
    </div>
    <p class="muted">GerÃ¤te-ID: <span id="deviceId"></span></p>
  </section>

  <!-- QUIZ -->
  <section id="screen-quiz" class="card" style="display:none">
    <div class="big" id="question">â€“</div>
    <div class="input-inline">
      <input id="answer" type="text" inputmode="decimal" placeholder="Antwort eingeben">
      <button id="ok">OK</button>
    </div>
    <p class="muted" id="progress"></p>
  </section>

  <!-- RESULTS -->
  <section id="screen-results" class="card" style="display:none">
    <h2>Auswertung</h2>
    <div class="grid">
      <div><div id="summary" class="big" style="font-size:28px"></div></div>
      <div>
        <div id="timing" class="card" style="border:none; box-shadow:none; padding:0">
          <div><b>Zeit-Statistik</b></div>
          <div id="timingStats" class="muted"></div>
        </div>
      </div>
    </div>
    <hr>
    <div id="hotspots"></div>
    <hr>
    <div class="results"><pre id="details"></pre></div>
    <div class="buttons">
      <button id="again" class="secondary">ZurÃ¼ck zu den Einstellungen</button>
      <button id="download" class="secondary">CSV herunterladen</button>
      <button id="send" class="">An Zentrale senden</button>
    </div>
    <p class="muted" id="sendStatus"></p>
  </section>
</div>

<script>
/* ===== Server-URL (deine Apps-Script Web-App) ===== */
const SERVER_URL = "https://script.google.com/macros/s/AKfycbx9xCriIcD_W0MkvfaEY9Jcte1JV60poZwXCCunSFzwMT1jL81HdC0kb9bKPUERy47wFw/exec";
const SHARED_SECRET = ""; // falls im Apps-Script gesetzt

/* ===== GerÃ¤tekennung ===== */
function getDeviceId() {
  const key = 'kopftrainer_device_id';
  let id = localStorage.getItem(key);
  if (!id) {
    id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
    localStorage.setItem(key, id);
  }
  return id;
}
const DEVICE_ID = getDeviceId();
document.getElementById('deviceId').textContent = DEVICE_ID;

/* ===== DOM Helpers ===== */
const S = id => document.getElementById(id);
const show = id => S(id).style.display = '';
const hide = id => S(id).style.display = 'none';

/* ===== State ===== */
let cfg = {}, tasks = [], results = [], opsUsed = [];
let idx = 0, answers = [], correctFlags = [];
let durations = []; let tStartQ = 0; let timerNext = null;

/* UI Bindings */
document.querySelectorAll('#ops .toggle').forEach(btn=>{
  btn.addEventListener('click', ()=>btn.classList.toggle('active'));
});
S('advToggle').addEventListener('change', e=>{
  S('advPanel').style.display = e.target.checked ? '' : 'none';
});

S('quit').addEventListener('click', ()=>{ resetAll(); alert('Trainer beendet.'); });

S('start').addEventListener('click', ()=>{
  const opsBase = [...document.querySelectorAll('#ops .toggle.active')].map(b=>b.dataset.op);
  if (opsBase.length===0) { alert('Bitte mindestens eine Rechenart wÃ¤hlen.'); return; }

  const useAdv = S('advToggle').checked;

  cfg = {
    name: S('name').value.trim() || 'Unbekannt',
    group: S('group').value.trim() || '-',
    min: parseInt(S('min').value,10) || 1,
    max: parseInt(S('max').value,10) || 150,
    allowNeg: S('neg').checked,
    divInt: S('divInt').checked,
    count: Math.max(1, Math.min(500, parseInt(S('count').value,10) || 7)),
    gap: Math.max(0, parseFloat(S('gap').value) || 0.5),
    think: Math.max(0, parseFloat(S('think').value) || 0),
    ops: opsBase,
    useAdv,
    adv: {}
  };

  if (useAdv) {
    document.querySelectorAll('#advPanel tbody tr').forEach(tr=>{
      const op = tr.dataset.op;
      const active = tr.querySelector('.op-active').checked;
      const min = parseInt(tr.querySelector('.op-min').value,10) || cfg.min;
      const max = parseInt(tr.querySelector('.op-max').value,10) || cfg.max;
      const weight = Math.max(0, parseInt(tr.querySelector('.op-weight').value,10) || 0);
      cfg.adv[op] = {active, min, max, weight};
    });
    const finalOps = Object.entries(cfg.adv)
      .filter(([op, o])=>o.active && opsBase.includes(op) && o.min < o.max && o.weight >= 0);
    if (finalOps.length===0) { alert('Im erweiterten Modus ist kein Operator aktiv/valide.'); return; }
  } else {
    if (cfg.min >= cfg.max) { alert('Minimum muss kleiner als Maximum sein.'); return; }
  }

  tasks = []; results = []; opsUsed = [];
  for (let i=0;i<cfg.count;i++){
    const {q,val,op} = makeTask(cfg);
    tasks.push(q); results.push(val); opsUsed.push(op);
  }
  idx=0; answers=[]; correctFlags=[]; durations=[];
  hide('screen-settings'); show('screen-quiz'); renderQuestion();
});

/* ===== Ablauf ===== */
function renderQuestion(){
  if (idx >= tasks.length){ showResults(); return; }
  S('question').textContent = `Aufgabe ${idx+1} / ${cfg.count}\n\n${tasks[idx]}`;
  S('progress').textContent = '';
  S('answer').value = ''; S('answer').focus();
  tStartQ = performance.now();
}
S('ok').addEventListener('click', submitAnswer);
S('answer').addEventListener('keydown', e=>{ if (e.key==='Enter') submitAnswer(); });

function submitAnswer(){
  if (idx >= tasks.length) return;
  const tEnd = performance.now();
  const dtSec = Math.max(0, (tEnd - tStartQ)/1000);
  durations.push(dtSec);

  let t = (S('answer').value||'').trim().replace(',', '.');
  if (t===''){ alert('Bitte eine Zahl eingeben.'); durations.pop(); return; }
  let a = Number(t);
  if (!isFinite(a)){ alert('Bitte eine gÃ¼ltige Zahl eingeben.'); durations.pop(); return; }

  answers.push(a);
  const correct = results[idx];
  const ok = (typeof correct === 'number' && !Number.isInteger(correct))
              ? Math.abs(a - correct) < 1e-9 : a === correct;
  correctFlags.push(!!ok);
  idx++;

  if (idx >= tasks.length){ showResults(); }
  else { clearTimeout(timerNext); timerNext = setTimeout(renderQuestion, Math.max(100, cfg.gap*1000)); }
}

/* ===== Ergebnisse ===== */
function showResults(){
  hide('screen-quiz'); show('screen-results');

  const total = tasks.length;
  const correct = correctFlags.filter(Boolean).length;
  const pct = total ? (100*correct/total) : 0;
  S('summary').textContent = `${cfg.name} (${cfg.group}) â€“ Richtig: ${correct} / ${total}  (${pct.toFixed(1)}%)`;

  const avg = durations.reduce((a,b)=>a+b,0) / (durations.length||1);
  const sorted = [...durations].sort((a,b)=>a-b);
  const med = sorted.length ? (sorted.length%2 ? sorted[(sorted.length-1)/2] : (sorted[sorted.length/2-1]+sorted[sorted.length/2])/2) : 0;
  const fastest = durations.length ? Math.min(...durations) : 0;
  const slowest = durations.length ? Math.max(...durations) : 0;
  S('timingStats').innerHTML = `Ã˜&nbsp;Zeit/ Aufgabe: <b>${avg.toFixed(2)}s</b><br>
    Median: <b>${med.toFixed(2)}s</b><br>
    Schnellste: <b>${fastest.toFixed(2)}s</b> â€“ Langsamste: <b>${slowest.toFixed(2)}s</b>`;

  const per = { '+':[0,0,0], '-':[0,0,0], '*':[0,0,0], '/':[0,0,0] };
  correctFlags.forEach((ok,i)=>{ const op=opsUsed[i]; per[op][1]++; if (ok) per[op][0]++; per[op][2]+=durations[i]||0; });

  let hot = `<h3>Fehlerschwerpunkte</h3><ul>`;
  Object.entries(per).forEach(([op,[ok,tot,sumT]])=>{
    if (tot){
      const acc = Math.round(100*ok/tot);
      const avgT = (sumT/tot)||0;
      const cls = (acc<70)?'bad':(acc>=90?'ok':'');
      hot += `<li>${op}: <span class="${cls}">${ok}/${tot} (${acc}%)</span>, Ã˜&nbsp;Zeit: ${avgT.toFixed(2)}s</li>`;
    }
  });
  hot += `</ul>`;
  const wrong = [];
  tasks.forEach((q,i)=>{ if (!correctFlags[i]) wrong.push({i, q, corr: results[i], ans: answers[i], op: opsUsed[i], t: durations[i]}); });
  if (wrong.length){
    hot += `<div class="muted">Falsche Aufgaben (${wrong.length}):</div><ul>`;
    wrong.forEach(w=>{ hot += `<li>${w.i+1}. ${w.q} = ${w.corr} | deine Antwort: <b>${w.ans}</b> (${w.op}, ${w.t.toFixed(2)}s)</li>`; });
    hot += `</ul>`;
  } else {
    hot += `<div class="ok">Keine Fehler â€“ stark!</div>`;
  }
  S('hotspots').innerHTML = hot;

  const lines = [];
  tasks.forEach((q,i)=>{
    const ok = correctFlags[i]; const m = ok ? 'âœ“' : 'âœ—';
    lines.push(`${i+1}. ${q}  =  ${results[i]}   | deine Antwort: ${answers[i]}   ${m}   (${opsUsed[i]}, ${durations[i].toFixed(2)}s)`);
  });
  S('details').textContent = lines.join('\n');
}

/* ===== Export/Senden ===== */
S('again').addEventListener('click', ()=>{ resetAll(); });
S('download').addEventListener('click', ()=>downloadCSV());
S('send').addEventListener('click', ()=>sendToServer());

function dataset(){
  const now = new Date().toISOString();
  const ds = {
    device_id: DEVICE_ID, timestamp: now,
    name: cfg.name, group: cfg.group,
    settings: {
      ops: cfg.ops, min: cfg.min, max: cfg.max,
      allow_neg: cfg.allowNeg, div_int: cfg.divInt,
      count: cfg.count, gap: cfg.gap, think: cfg.think,
      use_adv: cfg.useAdv, adv: cfg.adv
    },
    score: { correct: correctFlags.filter(Boolean).length, total: tasks.length,
             percent: tasks.length? (100*correctFlags.filter(Boolean).length/tasks.length):0 },
    timing: {
      per_question_s: durations,
      avg_s: durations.length? (durations.reduce((a,b)=>a+b,0)/durations.length):0,
      median_s: (()=>{const s=[...durations].sort((a,b)=>a-b);return s.length?(s.length%2?s[(s.length-1)/2]:(s[s.length/2-1]+s[s.length/2])/2):0;})()
    },
    items: tasks.map((q,i)=>({ q, op: opsUsed[i], answer: answers[i], correct: results[i], is_correct: !!correctFlags[i], time_s: durations[i] }))
  };
  if (SHARED_SECRET) ds.secret = SHARED_SECRET;
  return ds;
}

function downloadCSV(){
  const d = dataset();
  const header = 'timestamp,device_id,name,group,correct,total,percent,ops,avg_time_s,median_time_s\n';
  const row = `${d.timestamp},${d.device_id},${csv(d.name)},${csv(d.group)},${d.score.correct},${d.score.total},${d.score.percent.toFixed(1)},${csv(d.settings.ops.join(''))},${d.timing.avg_s.toFixed(2)},${d.timing.median_s.toFixed(2)}\n`;
  const blob = new Blob([header, row], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'kopftrainer_stats.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
const csv = s => `"${String(s).replaceAll('"','""')}"`;

/* ===== NEU: CORS-sicherer Upload (text/plain) ===== */
async function sendToServer(){
<script>
async function sendToServer(){
  const status = document.getElementById('sendStatus');
  status.textContent = 'Sende â€¦';

  const payload = JSON.stringify(dataset());
  const url = SERVER_URL + (SERVER_URL.includes('?') ? '&' : '?') + 't=' + Date.now(); // cache-bust

  try {
    // 1) PrimÃ¤rer Versuch: text/plain (simple request, keine Preflight-CORS)
    let res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: payload
    });

    // Versuche JSON zu lesen (Apps Script antwortet i. d. R. mit {ok:true})
    let ok = res.ok;
    let msg = `HTTP ${res.status}`;
    try {
      const js = await res.json();
      ok = ok && js.ok !== false;
      msg = js.ok ? 'Daten gesendet.' : (js.error || msg);
    } catch (_) { /* keine JSON-Antwort â€“ ignorieren */ }

    if (ok) {
      status.textContent = 'Daten gesendet.';
      return;
    }

    // 2) Fallback (no-cors): Browser zeigt keinen Status â€“ Server erhÃ¤lt die Daten trotzdem
    status.textContent = 'Sende im Fallback-Modus â€¦';
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: payload
    });
    // Wir kÃ¶nnen keine Antwort prÃ¼fen; sag dem Nutzer, er solle im Sheet nachsehen.
    status.textContent = 'Senden beauftragt (Fallback). PrÃ¼fe das Sheet.';
  } catch (err) {
    status.textContent = 'Senden fehlgeschlagen: ' + err.message;
  }
}

/* Kleiner Ping-Test, ob deine Web-App Ã¼berhaupt erreichbar ist (GET) */
async function pingServer(){
  const status = document.getElementById('sendStatus');
  try{
    const res = await fetch(SERVER_URL + (SERVER_URL.includes('?') ? '&' : '?') + 'ping=1');
    status.textContent = res.ok ? 'Ping OK (Server erreichbar).' : `Ping HTTP ${res.status}`;
  }catch(e){
    status.textContent = 'Ping fehlgeschlagen: ' + e.message;
  }
}
  }
}

function resetAll(){ clearTimeout(timerNext); show('screen-settings'); hide('screen-quiz'); hide('screen-results'); }

/* ===== Aufgaben-Generator (inkl. erweiterte Einstellungen) ===== */
function makeTask(cfg){
  let op;
  if (cfg.useAdv) {
    const pool = [];
    for (const o of Object.keys(cfg.adv)){
      const a = cfg.adv[o]; if (!a || !a.active || !cfg.ops.includes(o) || a.min >= a.max) continue;
      const w = Math.max(0, a.weight||0);
      for (let i=0;i<w;i++) pool.push(o);
    }
    const cand = pool.length ? pool
      : Object.keys(cfg.adv).filter(o=>cfg.adv[o].active && cfg.ops.includes(o) && cfg.adv[o].min < cfg.adv[o].max);
    op = cand[Math.floor(Math.random()*cand.length)];
  } else {
    op = cfg.ops[Math.floor(Math.random()*cfg.ops.length)];
  }

  const range = (o)=> cfg.useAdv ? {mn: cfg.adv[o].min, mx: cfg.adv[o].max} : {mn: cfg.min, mx: cfg.max};
  const {mn, mx} = range(op);
  const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  if (op==='+'){
    const a = rnd(mn,mx), b = rnd(mn,mx);
    return { q:`${a} + ${b}`, val:a+b, op:'+' };
  }
  if (op==='-'){
    let a = rnd(mn,mx), b = rnd(mn,mx);
    if (!cfg.allowNeg && a<b) [a,b] = [b,a];
    return { q:`${a} - ${b}`, val:a-b, op:'-' };
  }
  if (op==='*'){
    const a = rnd(mn,mx), b = rnd(mn,mx);
    return { q:`${a} Ã— ${b}`, val:a*b, op:'*' };
  }
  if (cfg.divInt){
    let res = rnd(Math.max(1,mn), Math.max(1,mx));
    let b   = rnd(Math.max(1,mn), Math.max(1,mx));
    if (cfg.allowNeg && Math.random()<0.5) res = -res;
    const a = res * b;
    return { q:`${a} Ã· ${b}`, val:res, op:'/' };
  } else {
    let a = rnd(mn,mx), b = rnd(Math.max(1,mn), Math.max(1,mx));
    if (!cfg.allowNeg){ a = Math.abs(a); b = Math.abs(b); }
    return { q:`${a} Ã· ${b}`, val:a/b, op:'/' };
  }
}
</script>
</body>
</html>













