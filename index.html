<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kopfrechnen Trainer â€“ Einfach</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f4f4f5;
      margin:0;
      padding:16px;
      text-align:center;
    }
    .card {
      max-width:600px;
      margin:0 auto;
      background:white;
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    h1 { margin-top:0; }
    input {
      font-size:16px;
      padding:8px;
      width:100%;
      max-width:260px;
      border-radius:8px;
      border:1px solid #d4d4d8;
      margin:4px 0 10px;
    }
    button {
      font-size:16px;
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      margin:4px;
    }
    button.primary { background:#2563eb; color:white; }
    button.secondary { background:#e4e4e7; color:#111827; }
    #taskBox {
      margin-top:16px;
      padding:12px;
      border-radius:12px;
      background:#f9fafb;
      display:none;
    }
    #resultBox {
      margin-top:16px;
      padding:12px;
      border-radius:12px;
      background:#ecfdf3;
      display:none;
    }
    .label { font-weight:600; }
    #status { margin-top:8px; font-size:14px; color:#4b5563; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ§® Kopfrechnen Trainer</h1>

    <!-- Startbereich: Name & Klasse -->
    <div id="startBox">
      <p>Bitte Name und Klasse eingeben:</p>
      <div>
        <div class="label">Name</div>
        <input id="inpName" placeholder="Vorname Nachname">
      </div>
      <div>
        <div class="label">Klasse</div>
        <input id="inpClass" placeholder="z. B. 5a">
      </div>
      <button id="btnStart" class="primary">Los gehtâ€™s</button>
    </div>

    <!-- Aufgabenbereich -->
    <div id="taskBox">
      <div id="taskHeader" class="label"></div>
      <div id="taskText" style="font-size:26px; margin:12px 0;"></div>
      <div>
        <div>Deine Antwort:</div>
        <input id="inpAnswer" type="number" inputmode="decimal">
      </div>
      <button id="btnNext" class="primary">Weiter</button>
      <button id="btnAbort" class="secondary">Abbrechen</button>
    </div>

    <!-- Ergebnisbereich -->
    <div id="resultBox">
      <h3>Auswertung</h3>
      <div id="resultText"></div>
      <div id="status"></div>
      <button id="btnRestart" class="secondary">Neue Runde</button>
    </div>
  </div>

  <script>
    /********** 1. SERVER-URL EINTRAGEN **********/
    // <-- HIER deine Apps-Script-Web-App-URL eintragen (mit /exec am Ende)
    const SERVER_URL = 'https://script.google.com/macros/s/AKfycbxxZI85PD70rdlnxLFXOwiGe_tcLVu1NCRaP-wWlncKzhNTFyg3aCHARYCnNFj_8CPkSg/exec';

    /********** 2. Feste Einstellungen **********/
    const CONFIG = {
      count: 10,               // Anzahl Aufgaben
      min: 1,                  // kleinste Zahl
      max: 150,                // grÃ¶ÃŸte Zahl
      ops: ['+','-','*','/'],  // erlaubte Rechenarten
      allowNeg: false,         // negative Ergebnisse erlauben?
      divInt: true             // Division nur mit ganzzahligem Ergebnis?
    };

    /********** 3. Hilfsfunktionen **********/
    const S = id => document.getElementById(id);

    function randInt(a,b){
      return Math.floor(Math.random() * (b - a + 1)) + a;
    }

    function generateTask(){
      const op = CONFIG.ops[Math.floor(Math.random() * CONFIG.ops.length)];
      let a, b, erg;

      if (op === '+') {
        a = randInt(CONFIG.min, CONFIG.max);
        b = randInt(CONFIG.min, CONFIG.max);
        erg = a + b;
      } else if (op === '-') {
        a = randInt(CONFIG.min, CONFIG.max);
        b = randInt(CONFIG.min, CONFIG.max);
        erg = a - b;
        if (!CONFIG.allowNeg && erg < 0) {
          const tmp = a; a = b; b = tmp;
          erg = a - b;
        }
      } else if (op === '*') {
        a = randInt(1, 12);
        b = randInt(1, 12);
        erg = a * b;
      } else if (op === '/') {
        if (CONFIG.divInt) {
          b = randInt(1, 12);
          erg = randInt(1, 12);
          a = b * erg;
        } else {
          b = randInt(1, 12);
          a = randInt(1, 144);
          erg = a / b;
        }
      }
      return { a, b, op, erg };
    }

    /********** 4. Zustand **********/
    let currentIndex = 0;
    let tasks = [];
    let answers = [];
    let startTime = null;
    let studentName = '';
    let studentClass = '';

    /********** 5. UI-Steuerung **********/
    function showStart(){
      S('startBox').style.display = 'block';
      S('taskBox').style.display = 'none';
      S('resultBox').style.display = 'none';
      S('status').textContent = '';
    }

    function showTask(){
      S('startBox').style.display = 'none';
      S('taskBox').style.display = 'block';
      S('resultBox').style.display = 'none';

      const t = tasks[currentIndex];
      S('taskHeader').textContent = 'Aufgabe ' + (currentIndex + 1) + ' von ' + CONFIG.count;
      S('taskText').textContent = t.a + ' ' + t.op + ' ' + t.b + ' = ?';
      S('inpAnswer').value = '';
      S('inpAnswer').focus();
    }

    function showResult(){
      S('startBox').style.display = 'none';
      S('taskBox').style.display = 'none';
      S('resultBox').style.display = 'block';

      let correct = 0;
      let detail = '';
      for (let i = 0; i < tasks.length; i++) {
        const t = tasks[i];
        const userAns = answers[i];
        const ok = Math.abs(userAns - t.erg) < 0.0001;
        if (ok) correct++;
        detail +=
          (i+1) + '. ' +
          t.a + ' ' + t.op + ' ' + t.b +
          ' = ' + t.erg +
          ' (deine Antwort: ' + userAns + (ok ? ' âœ“' : ' âœ—') + ')<br>';
      }

      const total = tasks.length;
      const durationSec = (Date.now() - startTime) / 1000;
      const pct = total > 0 ? (correct / total * 100).toFixed(1) : '0.0';

      S('resultText').innerHTML =
        '<p>' + studentName + ' (' + studentClass + ')</p>' +
        '<p>Richtig: ' + correct + ' von ' + total + ' (' + pct + '%)</p>' +
        '<p>Gesamtzeit: ' + durationSec.toFixed(1) + ' s (Ã˜ ' +
        (durationSec/total).toFixed(2) + ' s pro Aufgabe)</p>' +
        '<hr>' + detail;

      sendResults(total, correct, durationSec);
    }

    /********** 6. Ergebnisse an Google senden **********/
    async function sendResults(total, correct, timeSec){
      S('status').textContent = 'Sende Ergebnisse â€¦';
      const payload = {
        run_id: 'run-' + Date.now(),
        name: studentName,
        group: studentClass,
        total: total,
        correct: correct,
        time: timeSec,
        score: correct * 10   // einfache Score-Logik
      };
      try {
        const res = await fetch(SERVER_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const js = await res.json();
        if (js.ok) {
          S('status').textContent = 'Ergebnisse wurden gespeichert.';
        } else {
          S('status').textContent = 'Fehler beim Senden: ' + (js.error || 'unbekannt');
        }
      } catch (e) {
        S('status').textContent = 'Netzwerkfehler: ' + e.message;
      }
    }

    /********** 7. Event-Handler **********/
    S('btnStart').addEventListener('click', () => {
      studentName = S('inpName').value.trim();
      studentClass = S('inpClass').value.trim();
      if (!studentName || !studentClass) {
        alert('Bitte Name und Klasse eingeben.');
        return;
      }
      tasks = [];
      answers = [];
      for (let i = 0; i < CONFIG.count; i++) {
        tasks.push(generateTask());
      }
      currentIndex = 0;
      startTime = Date.now();
      showTask();
    });

    S('btnNext').addEventListener('click', () => {
      const val = S('inpAnswer').value;
      if (val === '') {
        alert('Bitte eine Antwort eingeben.');
        return;
      }
      answers[currentIndex] = Number(val);
      if (currentIndex < CONFIG.count - 1) {
        currentIndex++;
        showTask();
      } else {
        showResult();
      }
    });

    S('btnAbort').addEventListener('click', () => {
      if (confirm('Willst du wirklich abbrechen?')) {
        showStart();
      }
    });

    S('btnRestart').addEventListener('click', () => {
      showStart();
    });

    S('inpAnswer').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        S('btnNext').click();
      }
    });

    // Initialzustand
    showStart();
  </script>
</body>
</html>
