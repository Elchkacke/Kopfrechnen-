<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kopfrechnen Trainer</title>
<style>
body {font-family: system-ui, sans-serif; background:#f6f6f6; margin:0; padding:2em; text-align:center;}
h1 {margin-top:0;}
input,button {font-size:1.2em; padding:0.4em;}
input {border:1px solid #ccc; border-radius:6px;}
button {border:none; border-radius:8px; cursor:pointer;}
button.primary {background:#007bff; color:white;}
#cfgInfo {margin:1em 0; color:#333;}
#adminDlg {border:none; border-radius:12px; padding:1em; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.3);}
.chip {display:inline-block; border:1px solid #aaa; border-radius:20px; padding:0.3em 0.8em; margin:0.2em; cursor:pointer;}
.chip.active {background:#007bff; color:#fff;}
.hint {font-size:0.8em; color:#777;}
</style>
</head>

<body>
  <h1>Kopfrechnen Trainer</h1>

  <div id="cfgInfo">Konfiguration: wird geladen …</div>

  <div>
    <label>Name:<br><input id="stName" placeholder="Vorname Nachname"></label><br><br>
    <label>Klasse:<br><input id="stClass" placeholder="z. B. 5a"></label><br><br>
    <button id="startBtn" class="primary">Los geht’s</button>
    <button id="sendExample">Test-Upload</button>
  </div>

  <p id="status"></p>

  <button id="openAdmin">⚙️ Lehrer-Einstellungen</button>

  <!-- Lehrer-Dialog -->
  <dialog id="adminDlg">
    <h3>Lehrer-Einstellungen</h3>
    <label>Admin-PIN:<br>
      <input type="password" id="adminPin" placeholder="PIN eingeben">
    </label>
    <p id="adminMsg" class="hint"></p>
    <button id="adminLoad">Konfiguration laden</button>
    <button id="adminSave" class="primary">Speichern</button>
    <button id="openDash">Dashboard öffnen</button>
    <hr>
    <div>
      <div id="opsChips">
        <span class="chip" data-op="+">+</span>
        <span class="chip" data-op="-">−</span>
        <span class="chip" data-op="*">×</span>
        <span class="chip" data-op="/">÷</span>
      </div>
      <div>
        <label>Anzahl Aufgaben: <input id="cfgCount" type="number" min="1" max="100" value="12"></label><br>
        <label>Min: <input id="cfgMin" type="number" value="1"></label><br>
        <label>Max: <input id="cfgMax" type="number" value="150"></label><br>
        <label>Multiplikations-Max (×): <input id="cfgMultMax" type="number" value="12"></label><br>
        <label>Divisions-Max (÷): <input id="cfgDivMax" type="number" value="12"></label><br>
        <label><input id="cfgNeg" type="checkbox"> Negative Ergebnisse erlauben</label><br>
        <label><input id="cfgDivInt" type="checkbox" checked> Division nur ganzzahlig</label>
      </div>
    </div>
    <br>
    <button id="adminSave2" class="primary">Speichern</button>
    <button onclick="document.getElementById('adminDlg').close()">Schließen</button>
  </dialog>

  <!-- ==================== SCRIPT ==================== -->
  <script>
    /* === HIER DEINE GOOGLE WEB-APP-URL EINTRAGEN === */
    const SERVER_URL = 'https://script.google.com/macros/s/AKfycbxwBW0SQor_7odwQlm-IwDNn5T14_vJTxgAfgAE4bZyGyikVFUgPo6-rCpLrSN9bKhvag/exec';

    const S=id=>document.getElementById(id);
    const QA=(sel,root=document)=>Array.from(root.querySelectorAll(sel));

    /* Globale Config */
    let CURRENT_CFG = {count:12,ops:['+','-','*','/'],min:1,max:150,multMax:12,divMax:12,allowNeg:false,divInt:true};

    /* Form lesen/schreiben */
    function readCfg(){
      const ops=QA('.chip.active').map(c=>c.dataset.op);
      return {
        count:+S('cfgCount').value||12, ops:ops.length?ops:['+'],
        min:+S('cfgMin').value||1, max:+S('cfgMax').value||150,
        multMax:+S('cfgMultMax').value||12, divMax:+S('cfgDivMax').value||12,
        allowNeg:S('cfgNeg').checked, divInt:S('cfgDivInt').checked
      };
    }
    function writeCfg(c){
      if(!c)return;
      S('cfgCount').value=c.count??12;
      S('cfgMin').value=c.min??1; S('cfgMax').value=c.max??150;
      S('cfgMultMax').value=c.multMax??12; S('cfgDivMax').value=c.divMax??12;
      S('cfgNeg').checked=!!c.allowNeg; S('cfgDivInt').checked=c.divInt!==false;
      const sel=new Set((c.ops||['+','-','*','/']).map(String));
      QA('.chip').forEach(ch=>ch.classList.toggle('active',sel.has(ch.dataset.op)));
    }
    function showCfgInfo(c){
      S('cfgInfo').textContent=`Konfiguration: ${c.count} Aufgaben, Ops: ${(c.ops||[]).join(' ')}`;
    }

    /* Chips klicken */
    S('opsChips').addEventListener('click',e=>{
      const chip=e.target.closest('.chip'); if(chip)chip.classList.toggle('active');
    });

    /* Laden */
    async function loadConfig(){
      const msg=S('adminMsg'); msg.textContent='Lade Konfiguration …';
      try{
        const r=await fetch(`${SERVER_URL}?action=config&t=${Date.now()}`,{cache:'no-store'});
        const txt=await r.text();
        const js=JSON.parse(txt);
        if(!js.ok)throw new Error(js.error||'Fehlerhafte Antwort');
        CURRENT_CFG=js.config; writeCfg(CURRENT_CFG); showCfgInfo(CURRENT_CFG);
        msg.textContent='Konfiguration geladen.';
      }catch(e){
        msg.textContent='Load failed: '+e.message;
        console.error(e);
      }
    }

    /* Speichern */
    async function saveConfig(){
      const msg=S('adminMsg'); msg.textContent='Speichere …';
      const pin=(S('adminPin').value||'').trim(); if(!pin){alert('PIN fehlt');return;}
      const cfg=readCfg();
      try{
        const body=new URLSearchParams();
        body.set('type','config_form'); body.set('admin_key',pin);
        body.set('cfg',JSON.stringify(cfg));
        const r=await fetch(SERVER_URL,{method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body:body.toString(),cache:'no-store'});
        const txt=await r.text();
        if(!r.ok)throw new Error('HTTP '+r.status);
        if(txt.trim()!=='OK')throw new Error('Antwort: '+txt.slice(0,100));
        CURRENT_CFG=cfg; showCfgInfo(cfg); msg.textContent='Gespeichert.';
      }catch(e){ msg.textContent='Save failed: '+e.message; console.error(e); }
    }

    /* Dashboard */
    function openDashboard(){
      const pin=(S('adminPin').value||'').trim();
      if(!pin){alert('PIN fehlt');return;}
      window.open(`${SERVER_URL}?action=dashboard&admin_key=${encodeURIComponent(pin)}`,'_blank','noopener');
    }

    /* Start */
    S('startBtn').onclick=async()=>{
      const name=S('stName').value.trim();
      const cls=S('stClass').value.trim();
      if(!name||!cls){alert('Bitte Name & Klasse');return;}
      if(!CURRENT_CFG)await loadConfig();
      alert(`Starte Trainer für ${name} (${cls})\n${CURRENT_CFG.count} Aufgaben, Ops: ${CURRENT_CFG.ops.join(' ')}`);
    };

    /* Test-Upload */
    S('sendExample').onclick=async()=>{
      S('status').textContent='Sende Testdaten …';
      const payload={run_id:'demo-'+Date.now(),name:S('stName').value||'Demo',
        group:S('stClass').value||'Demo',total:12,correct:9,time:63.2,score:95};
      try{
        const r=await fetch(SERVER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const js=await r.json();
        S('status').textContent=js.ok?'Gesendet.':'Fehler: '+js.error;
      }catch(e){S('status').textContent='Netzwerkfehler: '+e.message;}
    };

    /* Events */
    S('openAdmin').onclick=()=>S('adminDlg').showModal();
    S('adminLoad').onclick=loadConfig;
    S('adminSave').onclick=saveConfig;
    S('adminSave2').onclick=saveConfig;
    S('openDash').onclick=openDashboard;

    /* Info beim Start */
    (async()=>{
      try{
        const r=await fetch(`${SERVER_URL}?action=config&t=${Date.now()}`,{cache:'no-store'});
        const js=await r.json();
        if(js.ok)CURRENT_CFG=js.config,showCfgInfo(CURRENT_CFG);
      }catch(_){showCfgInfo(CURRENT_CFG);}
    })();
  </script>
</body>
</html>
