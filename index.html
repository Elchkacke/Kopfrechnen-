<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Kopfrechnen â€“ Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0;
      padding:16px;
      background:#f4f4f5;
      color:#111827;
    }
    .wrap {
      max-width:1000px;
      margin:0 auto;
    }
    h1 { margin-top:0; font-size:22px; }
    .hint { font-size:13px; color:#6b7280; }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      background:white;
      border-radius:10px;
      overflow:hidden;
    }
    th, td {
      padding:8px 10px;
      border-bottom:1px solid #e5e7eb;
      font-size:14px;
    }
    th {
      text-align:left;
      background:#f3f4f6;
      font-weight:600;
    }
    tr:hover {
      background:#eff6ff;
      cursor:pointer;
    }
    tr.selected {
      background:#dbeafe !important;
    }
    .pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      background:#e5e7eb;
      color:#374151;
    }
    #detailBox {
      margin-top:24px;
      background:white;
      border-radius:10px;
      padding:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
    }
    #detailBox h2 {
      margin:0 0 4px;
      font-size:18px;
    }
    #detailHint { font-size:13px; color:#6b7280; margin-bottom:8px; }
    .bad { color:#b91c1c; font-weight:600; }
    .good { color:#15803d; font-weight:600; }
    .toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    button {
      font-size:14px;
      padding:6px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:#2563eb;
      color:white;
    }
    button.secondary {
      background:#e5e7eb;
      color:#111827;
    }
    #status { margin-top:4px; font-size:13px; color:#4b5563; }

    /* Fehlerschwerpunkte-Balken */
    .error-bar {
      height:8px;
      border-radius:999px;
      background:#fee2e2;
      position:relative;
      overflow:hidden;
    }
    .error-bar-inner {
      position:absolute;
      inset:0;
      background:#b91c1c;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1>ðŸ§® Kopfrechnen â€“ Dashboard</h1>
    <div>
      <span id="updated" class="pill">â€“</span>
      <button id="btnReload" class="secondary">Aktualisieren</button>
    </div>
  </div>
  <div class="hint">
    Ãœbersicht nach Klasse. Klicke eine Klasse in der Tabelle an, um Details und Fehlerschwerpunkte zu sehen.
  </div>

  <!-- Klassen-Ãœbersicht -->
  <table id="classTable">
    <thead>
      <tr>
        <th>Klasse</th>
        <th>Teilnehmer</th>
        <th>Ã˜ richtig %</th>
        <th>Ã˜ Zeit/Aufgabe (s)</th>
        <th>Ã˜ Score</th>
        <th>Summe richtig</th>
      </tr>
    </thead>
    <tbody id="classBody">
      <tr><td colspan="6">Lade Daten â€¦</td></tr>
    </tbody>
  </table>

  <!-- Detailansicht -->
  <div id="detailBox" style="display:none;">
    <h2 id="detailTitle">Details</h2>
    <div id="detailHint" class="hint"></div>

    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Klasse</th>
            <th>Richtig / Gesamt</th>
            <th>%</th>
            <th>Ã˜ Zeit/Aufgabe (s)</th>
            <th>Score</th>
            <th>Zeitstempel</th>
          </tr>
        </thead>
        <tbody id="detailBody">
          <tr><td colspan="7">Keine Daten</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Fehlerschwerpunkte nach Rechenart -->
    <h3 style="margin-top:16px;">Fehlerschwerpunkte (nach Rechenart)</h3>
    <div class="hint" id="errorHint">
      Zeigt fÃ¼r diese Klasse, bei welchen Rechenarten am hÃ¤ufigsten Fehler auftreten.
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Rechenart</th>
            <th>Anzahl Aufgaben</th>
            <th>Fehler</th>
            <th>Fehlerquote</th>
            <th>Visualisierung</th>
          </tr>
        </thead>
        <tbody id="errorBody">
          <tr><td colspan="5">Keine Fehlerschwerpunkt-Daten.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="status"></div>
</div>

<script>
(function(){
  // Basis-URL der Web-App (ohne Query-Parameter)
  const href   = window.location.href;
  const baseUrl = href.split('https://script.google.com/macros/s/AKfycbxmHegvBVeMLwqRP8yLcm6NzIfhlc6-IRHxxp-NoEp7aH157qX4GjyQI1tBv5EtQQzGGA/exec')[0];
  const params  = new URLSearchParams(window.location.search);
  const ADMIN_KEY = params.get('admin_key') || '';

  const classBody   = document.getElementById('classBody');
  const detailBox   = document.getElementById('detailBox');
  const detailBody  = document.getElementById('detailBody');
  const detailTitle = document.getElementById('detailTitle');
  const detailHint  = document.getElementById('detailHint');
  const errorBody   = document.getElementById('errorBody');
  const statusEl    = document.getElementById('status');
  const updatedEl   = document.getElementById('updated');
  const btnReload   = document.getElementById('btnReload');

  function fmtPercent(p){
    return (p != null && !isNaN(p)) ? p.toFixed(1).replace('.',',')+' %' : 'â€“';
  }
  function fmtTime(t){
    return (t != null && !isNaN(t)) ? t.toFixed(2).replace('.',',') : 'â€“';
  }
  function fmtScore(s){
    return (s != null && !isNaN(s)) ? s.toFixed(1).replace('.',',') : 'â€“';
  }

  function symbolForOp(op){
    if (op === '+') return '+ (Addition)';
    if (op === '-') return 'âˆ’ (Subtraktion)';
    if (op === '*') return 'Ã— (Multiplikation)';
    if (op === '/') return 'Ã· (Division)';
    return op || '?';
  }

  async function loadStats(){
    statusEl.textContent = 'Lade KlassenÃ¼bersicht â€¦';
    classBody.innerHTML = '<tr><td colspan="6">Lade Daten â€¦</td></tr>';

    try{
      const url = baseUrl + '?action=stats&t=' + Date.now();
      const res = await fetch(url, {cache:'no-store'});
      const js  = await res.json();

      if (js.ok === false) {
        // Serverseitiger Fehler wird direkt angezeigt
        classBody.innerHTML =
          '<tr><td colspan="6">Fehler in stats: ' +
          (js.error || 'Unbekannter Fehler') + '</td></tr>';
        statusEl.textContent = 'Fehler in stats: ' + (js.error || '');
        return;
      }

      const classes = js.classes || [];
      if (!classes.length){
        classBody.innerHTML = '<tr><td colspan="6">Noch keine Ergebnisse.</td></tr>';
      } else {
        classBody.innerHTML = '';
        classes.forEach(cls=>{
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>'+cls.class+'</td>'+
            '<td>'+cls.participants+'</td>'+
            '<td>'+fmtPercent(cls.avgPercent)+'</td>'+
            '<td>'+fmtTime(cls.avgTimeSec)+'</td>'+
            '<td>'+fmtScore(cls.avgScore)+'</td>'+
            '<td>'+cls.sumCorrect+'</td>';
          tr.addEventListener('click', ()=>selectClass(cls.class, tr));
          classBody.appendChild(tr);
        });
      }
      updatedEl.textContent = 'Stand: ' + (js.updated || 'â€“');
      statusEl.textContent = 'Ãœbersicht geladen.';
    }catch(e){
      console.error('loadStats error', e);
      classBody.innerHTML =
        '<tr><td colspan="6">Fehler beim Laden der Ãœbersicht: '+
        (e.message || e) +'</td></tr>';
      statusEl.textContent = 'Fehler beim Laden der Ãœbersicht: ' + (e.message || e);
    }
  }

  async function selectClass(clsName, rowEl){
    Array.from(classBody.querySelectorAll('tr')).forEach(tr=>tr.classList.remove('selected'));
    if (rowEl) rowEl.classList.add('selected');

    statusEl.textContent = 'Lade Details fÃ¼r Klasse '+clsName+' â€¦';
    detailBox.style.display = 'block';
    detailTitle.textContent = 'Klasse ' + clsName;
    detailBody.innerHTML = '<tr><td colspan="7">Lade â€¦</td></tr>';
    errorBody.innerHTML  = '<tr><td colspan="5">Lade Fehlerschwerpunkte â€¦</td></tr>';

    try{
      const url = baseUrl + '?action=class&cls=' +
                  encodeURIComponent(clsName) +
                  '&t=' + Date.now();
      const res = await fetch(url, {cache:'no-store'});
      const js  = await res.json();

      if (js.ok === false) {
        // Serverseitiger Fehler hier klar anzeigen
        detailBody.innerHTML =
          '<tr><td colspan="7">Fehler in class: '+
          (js.error || 'Unbekannter Fehler') +'</td></tr>';
        errorBody.innerHTML =
          '<tr><td colspan="5">Fehler in class: '+
          (js.error || 'Unbekannter Fehler') +'</td></tr>';
        statusEl.textContent = 'Fehler in class: ' + (js.error || '');
        return;
      }

      // 1) Lauf-Details
      const rows = js.rows || [];
      if (!rows.length){
        detailBody.innerHTML =
          '<tr><td colspan="7">Noch keine Ergebnisse fÃ¼r diese Klasse.</td></tr>';
      } else {
        detailBody.innerHTML = '';
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          const pctVal = (r.percent != null) ? Number(r.percent) : null;
          const pctStr = (pctVal != null && !isNaN(pctVal))
                         ? pctVal.toFixed(1).replace('.',',')
                         : 'â€“';
          const pctClass = (pctVal != null && !isNaN(pctVal))
                           ? (pctVal < 60 ? 'bad' : 'good')
                           : '';
          // ðŸ‘‰ kein Date.parse, einfach String anzeigen
          const ts = (r.timestamp || '').toString();

          tr.innerHTML =
            '<td>'+ (r.name || '') +'</td>'+
            '<td>'+ (r.group || '') +'</td>'+
            '<td>'+ (r.correct || 0) +' / '+ (r.total || 0) +'</td>'+
            '<td class="'+pctClass+'">'+ pctStr +'</td>'+
            '<td>'+ fmtTime(r.time_s) +'</td>'+
            '<td>'+ fmtScore(r.score) +'</td>'+
            '<td>'+ ts +'</td>';
          detailBody.appendChild(tr);
        });
      }
      detailHint.textContent =
        'Rot markierte Prozentwerte (< 60 %) zeigen mÃ¶gliche SchwÃ¤chen einzelner SchÃ¼ler.';

      // 2) Fehlerschwerpunkte nach Rechenart
      const ops = js.errorsByOp || [];
      if (!ops.length){
        errorBody.innerHTML =
          '<tr><td colspan="5">Noch keine Aufgaben-Details fÃ¼r diese Klasse gespeichert.</td></tr>';
      } else {
        errorBody.innerHTML = '';
        ops.forEach(o=>{
          const tr = document.createElement('tr');
          const rateVal = Number(o.errorRate || 0);
          const rateStr = rateVal.toFixed(1).replace('.',',') + ' %';

          const barOuter = document.createElement('div');
          barOuter.className = 'error-bar';
          const barInner = document.createElement('div');
          barInner.className = 'error-bar-inner';
          barInner.style.width = Math.min(100, Math.max(0, rateVal)) + '%';
          barOuter.appendChild(barInner);

          const tdVis = document.createElement('td');
          tdVis.appendChild(barOuter);

          tr.innerHTML =
            '<td>'+ symbolForOp(o.op) +'</td>'+
            '<td>'+ (o.total || 0) +'</td>'+
            '<td>'+ (o.errors || 0) +'</td>'+
            '<td>'+ rateStr +'</td>';
          tr.appendChild(tdVis);

          errorBody.appendChild(tr);
        });
      }

      statusEl.textContent = 'Details fÃ¼r Klasse '+clsName+' geladen.';
    }catch(e){
      console.error('selectClass error', e);
      detailBody.innerHTML =
        '<tr><td colspan="7">Fehler beim Laden der Details: '+
        (e.message || e) +'</td></tr>';
      errorBody.innerHTML  =
        '<tr><td colspan="5">Fehler beim Laden der Fehlerschwerpunkte.</td></tr>';
      statusEl.textContent = 'Fehler beim Laden der Details: ' + (e.message || e);
    }
  }

  btnReload.addEventListener('click', loadStats);
  loadStats();
})();
</script>
</body>
</html>
