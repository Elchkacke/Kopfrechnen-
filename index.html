<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Kopfrechnen Trainer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    button{appearance:none;border:none;background:#0a84ff;color:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111}
    dialog{border:none;border-radius:12px;padding:0;max-width:92vw}
    dialog form{padding:16px}
    .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
    input,select{padding:8px;border:1px solid #e5e7eb;border-radius:8px;width:100%}
    label{display:grid;gap:6px}
    .grid{display:grid;gap:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üßÆ Kopfrechnen</h1>
    <div>
      <button id="openAdmin" class="secondary">Lehrer-Men√º</button>
    </div>
  </header>

  <!-- Sch√ºler-Eingabe (Name/Klasse) ‚Äì Platzhalter -->
  <section class="grid">
    <label><span>Name</span><input id="stName" placeholder="Vorname Nachname"></label>
    <label><span>Klasse</span><input id="stClass" placeholder="z.B. 5a"></label>
    <button id="startBtn">Los geht‚Äôs</button>
    <div id="status" style="color:#666"></div>
  </section>

  <!-- Lehrer-Dialog (mit Dashboard √∂ffnen) -->
  <dialog id="adminDlg">
    <form method="dialog" id="adminForm" style="min-width: min(92vw, 680px);">
      <header style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px;">
        <h3 style="margin:0;">Lehrer-Einstellungen</h3>
        <button id="adminClose" value="cancel" type="submit">Schlie√üen</button>
      </header>

      <section class="grid">
        <!-- Admin-PIN -->
        <label>
          <span>Admin-PIN</span>
          <input id="adminPin" type="password" inputmode="numeric" autocomplete="current-password"
                 placeholder="PIN eingeben" required />
        </label>

        <!-- Beispiel-Konfigfelder (kannst du anpassen/erweitern) -->
        <label><span>Anzahl Aufgaben (count)</span><input id="cfgCount" type="number" min="1" max="50" value="12"></label>
        <label><span>Zahlenbereich min</span><input id="cfgMin" type="number" value="1"></label>
        <label><span>Zahlenbereich max</span><input id="cfgMax" type="number" value="150"></label>
        <label><span>Rechenarten (ops, Komma-getrennt aus +,-,*,/)</span><input id="cfgOps" value="+,-,*,/"></label>
        <label><span>Negative Ergebnisse erlauben</span>
          <select id="cfgNeg"><option value="false">nein</option><option value="true">ja</option></select>
        </label>
        <label><span>Division nur ganzzahlig</span>
          <select id="cfgDivInt"><option value="true">ja</option><option value="false">nein</option></select>
        </label>
      </section>

      <footer class="foot">
        <button id="adminSave" type="button">Speichern</button>
        <button id="adminOpenDashboard" type="button" class="secondary">Dashboard √∂ffnen</button>
        <button id="adminClose2" type="submit" value="cancel" class="secondary">Schlie√üen</button>
      </footer>
    </form>
  </dialog>
</div>

<script>
  // ======= KONFIGURATION =======
  // Trage hier deine /exec-URL ein:
  const SERVER_URL = 'https://script.google.com/macros/s/AKfycbyxxdBXI5et69kTRQWgSZdmFYCwVfJzZZwkg-X__dO5VKSdjwmZxnK3lwtS3iaOgMYTZA/exec';

  const S = (id)=>document.getElementById(id);

  // Lehrer-Men√º √∂ffnen
  S('openAdmin').addEventListener('click', ()=> S('adminDlg').showModal());
  S('adminClose').addEventListener('click', ()=> S('adminDlg').close());
  S('adminClose2').addEventListener('click', ()=> S('adminDlg').close());

  // Admin: Speichern (CORS-frei, per form-url-encoded)
  S('adminSave').addEventListener('click', async ()=>{
    const pin = S('adminPin').value.trim();
    if (!pin){ alert('Bitte PIN eingeben'); return; }

    const cfg = {
      count: Number(S('cfgCount').value || 12),
      min: Number(S('cfgMin').value || 1),
      max: Number(S('cfgMax').value || 150),
      ops: (S('cfgOps').value || '+,-,*,/').split(',').map(s=>s.trim()).filter(Boolean),
      allowNeg: S('cfgNeg').value === 'true',
      divInt: S('cfgDivInt').value === 'true'
    };

    const form = new URLSearchParams();
    form.set('type', 'config_form');
    form.set('admin_key', pin);
    form.set('cfg', JSON.stringify(cfg));

    try {
      const res = await fetch(SERVER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: form.toString()
      });
      const txt = await res.text();
      if (txt.trim() === 'OK'){ alert('Konfiguration gespeichert.'); }
      else { alert('Unerwartete Antwort: ' + txt); }
    } catch (e) {
      alert('Fehler beim Speichern: ' + e.message);
    }
  });

  // Admin: Dashboard √∂ffnen (PIN-gesch√ºtzt)
  S('adminOpenDashboard').addEventListener('click', ()=>{
    const pin = (S('adminPin')?.value || '').trim();
    if (!pin){ alert('Bitte zuerst die Admin-PIN eingeben.'); return; }
    const url = `${SERVER_URL}?action=dashboard&admin_key=${encodeURIComponent(pin)}`;
    window.open(url, '_blank', 'noopener');
  });

  // ======= Sch√ºler-App ‚Äì Minimal (Platzhalter) =======
  S('startBtn').addEventListener('click', async ()=>{
    const name = S('stName').value.trim();
    const group= S('stClass').value.trim();
    if (!name || !group) { alert('Bitte Name und Klasse eintragen'); return; }

    // Beispiel-Run (hier w√ºrdest du deine Aufgaben generieren & messen)
    // Wir senden nur einen "Fake" Datensatz als Beispiel:
    const payload = {
      run_id: 'run-' + Date.now(),
      name, group,
      total: 12,
      correct: 10,
      time: 75.3,  // Gesamtzeit in s
      score: 103
    };

    try {
      const res = await fetch(SERVER_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const js = await res.json();
      if (js.ok) {
        S('status').textContent = 'Ergebnis gesendet. Danke!';
      } else {
        S('status').textContent = 'Fehler: ' + (js.error || 'unbekannt');
      }
    } catch (e) {
      S('status').textContent = 'Netzwerkfehler: ' + e.message;
    }
  });
</script>
</body>
</html>
